# 量子认证接口约定（V1 主仓对接）

> 主仓校验用户 token 时调用量子认证服务；若无独立服务则使用** stub 实现**（固定返回测试用户与档位）。与 [V1 阶段任务拆解](../../JobFirst/docs/V1阶段任务拆解.md) 阶段 2.1 对齐。

---

## 一、校验接口（主仓 → 量子认证）

主仓在需要鉴权的请求中拿到 `Authorization: Bearer <token>`，再调用认证服务校验 token 并获取用户身份与档位。

| 项目 | 约定 |
|------|------|
| **方法** | `GET` 或 `POST`（由认证服务实现决定；主仓 stub 不发起 HTTP） |
| **URL** | 由环境变量 `QUANTUM_AUTH_URL` 配置，例如 `http://localhost:8xxx/verify` 或 `https://auth.example.com/v1/verify` |
| **请求头** | `Authorization: Bearer <token>`（主仓将前端传来的 token 原样转发） |
| **请求体** | 若为 POST，可为空或 `{"token": "<token>"}`，依认证服务实际约定 |
| **响应 200** | JSON：`{ "user_id": string, "tier": "free" | "basic" | "pro", "claims"?: object }`。`user_id` 唯一标识用户；`tier` 与《认证订阅与档位设计》三档一致，供主仓做配额与权限判断 |
| **响应 4xx** | token 无效或过期：401；主仓据此对客户端返回 401，要求重新登录 |

---

## 二、主仓侧行为

- **未带 token**：请求头无 `Authorization` 或非 `Bearer xxx` → 主仓直接返回 **401**，不调用认证服务。
- **带 token**：主仓调用校验接口；若返回 200 则解析 `user_id`、`tier` 注入请求上下文（如 `AuthContext`），供后续业务与配额使用；若返回 4xx 或超时则主仓返回 **401**。

---

## 三、Stub 实现（无 QUANTUM_AUTH_URL 时）

当未配置 `QUANTUM_AUTH_URL` 时，主仓使用**内置 stub**，不发起 HTTP：

- 接受任意非空 token（包括 V0 演示用 `demo-token-xxx`）。
- 固定返回：`user_id = "stub-" + token 前 16 位`（或从 token 中解析出的邮箱等），`tier = "free"`。
- 便于本地与联调阶段不依赖认证服务即可跑通「鉴权 + 档位」链路；对接真实量子认证后关闭 stub。

---

## 四、档位取值与配额

| tier | 含义 | 配额见《认证订阅与档位设计》 |
|------|------|-----------------------------|
| `free` | 免费版 | 匹配 3 次/日、简历 1 份/日等 |
| `basic` | 基础版 | 匹配 20 次/日、简历 5 份/日等 |
| `pro` | Pro 版 | 高配额或不限 |

主仓仅使用 `user_id` 与 `tier`，配额逻辑在阶段 4 实现。

---

*文档版本：V1 阶段 2.1；若量子认证服务提供正式 API 文档，可替换或补充本节。*
