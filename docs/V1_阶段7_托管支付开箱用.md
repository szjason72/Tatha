# V1 阶段 7：支付与档位开通（托管支付开箱用）

主仓只做「创建订单 + Webhook 更新档位」，支付页由 **Lemon Squeezy** 托管；未配置时使用 **stub** 跑通整条链路。

## 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/v1/orders/checkout` | 需鉴权。入参 `tier`（basic\|pro）、`interval`（month\|year）、可选 `return_url`。返回 `checkout_url`，前端跳转该 URL 完成付款。未配置 Lemon Squeezy 时返回 stub URL（同源 `index.html?stub_checkout=1&...`）。 |
| POST | `/v1/webhooks/payment` | Lemon Squeezy Webhook。校验 `X-Signature` 后处理 `order_created` / `subscription_created`，将 `meta.custom_data.user_id` 对应档位写入 tier_store。 |
| POST | `/v1/webhooks/stub-upgrade` | 仅当**未配置** `LEMON_SQUEEZY_API_KEY` 时可用。Body: `{ "user_id": "...", "tier": "basic"\|"pro" }`，直接写档位，用于本地验证档位更新。 |

## 配置（.env）

见项目根目录 `.env.example` 中「V1 阶段 7：托管支付开箱用」：

- **公网地址**：`TATHA_PUBLIC_URL`（如 `https://www.genz.ltd`），用于生成 stub 的 return_url 等。
- **Lemon Squeezy**：`LEMON_SQUEEZY_API_KEY`、`LEMON_SQUEEZY_STORE_ID`、`LEMON_SQUEEZY_WEBHOOK_SECRET`
- **Variant ID**：`LEMON_SQUEEZY_VARIANT_BASIC_MONTHLY` / `_YEARLY`、`LEMON_SQUEEZY_VARIANT_PRO_MONTHLY` / `_YEARLY`（在 Lemon Squeezy 产品页获取）。

**Lemon Squeezy 后台需填写**（以公网 `https://www.genz.ltd` 为例）：
- **Webhook URL**：`https://www.genz.ltd/v1/webhooks/payment`（若 API 部署在子域如 `api.genz.ltd`，则填 `https://api.genz.ltd/v1/webhooks/payment`）。
- 结账成功跳转由前端请求 checkout 时传 `return_url`，建议：`https://www.genz.ltd/index.html?upgraded=1`。

未配置 API Key / Store / Variant 时，`/v1/orders/checkout` 返回 stub 的 `checkout_url`，前端跳转后显示「Stub 结账页」，点击「模拟支付成功」会调用 `/v1/webhooks/stub-upgrade` 并重定向回 `return_url`。

## 档位生效

档位写入 `tier_store`（内存或 Redis，见 `tatha.api.tier_store`）。鉴权时 `get_auth` 会优先使用 tier_store 中的覆盖，再使用量子认证返回的 tier，因此支付/订阅开通后下次带 token 请求即获得新档位与配额。

## 前端流程

1. 订阅页（index.html）点击「立即订阅」→ 未登录则跳转 `auth.html?redirect=index.html`，登录后回到订阅页再点。
2. 已登录时请求 `POST /v1/orders/checkout`，得到 `checkout_url` 后 `location.href = checkout_url`。
3. 真实支付：在 Lemon Squeezy 托管页付款，成功后跳转回 `return_url`（默认 `index.html?upgraded=1`）；Webhook 由 Lemon Squeezy 调用主仓 `/v1/webhooks/payment` 更新档位。
4. Stub：跳转到 stub URL 后出现「Stub 结账页」，点击「模拟支付成功」→ 调用 stub-upgrade → 重定向到 `?upgraded=1`，页面展示「升级成功」。

## 多端复用

同一套「创建订单 + Webhook 更新档位」可供 Web、小程序、H5 复用；各端仅负责调起支付（或打开 checkout_url），回调统一由主仓 Webhook 处理，档位与配额逻辑不变。

---

## 验收（阶段 7 如何验收）

### 前提

- 主仓 API 已启动（如 `http://localhost:8010`），**不配置** Lemon Squeezy 即可用 stub 验收。

### 方式一：Stub 链路（推荐，不依赖真实支付）

1. **创建订单**  
   - 用 Postman/curl：带 `Authorization: Bearer <任意 token>` 调用  
     `POST /v1/orders/checkout`，Body: `{ "tier": "basic", "interval": "month" }`。  
   - **通过标准**：返回 200，`checkout_url` 为同源 URL 且含 `stub_checkout=1`、`user_id`、`tier`。

2. **Stub 写档位**  
   - 调用 `POST /v1/webhooks/stub-upgrade`，Body: `{ "user_id": "<上一步 URL 里的 user_id>", "tier": "basic" }`。  
   - **通过标准**：返回 200，`ok: true`。

3. **档位生效**  
   - 用**同一 token** 调用需鉴权接口（如 `POST /v1/jobs/match`），多次调用直至接近 Basic 日配额（如 20 次）。  
   - **通过标准**：前 20 次返回 200，第 21 次返回 429（配额用尽），说明鉴权已按 basic 档位计配额。

4. **前端闭环（浏览器）**  
   - 打开订阅页 → 若未登录，点「立即订阅」应跳转登录页（带 `redirect=index.html`），登录后回到订阅页。  
   - 再点「立即订阅」→ 跳转到 Stub 结账页（同源，URL 带 `stub_checkout=1`）。  
   - 点击「模拟支付成功」→ 跳回订阅页且 URL 带 `upgraded=1`，页面显示「升级成功」。  
   - 进入使用页（demo.html），带 token 使用匹配等能力，确认配额为 Basic 档（如匹配 20 次/日）。

### 方式二：真实支付（可选）

- 在 Lemon Squeezy 创建 Store、产品与 Variant，配置 `.env` 中的 API Key、Store ID、Variant ID、Webhook Secret。  
- 在 Lemon Squeezy 后台将 Webhook URL 设为 `https://<你的主仓域名>/v1/webhooks/payment`。  
- 重复「前端闭环」：订阅页 → 立即订阅 → 跳转 Lemon Squeezy 托管页 → 完成测试支付 → 回站 `?upgraded=1`；后台 Webhook 被调用后，使用页带 token 请求应获得新档位与配额。

### 验收结论

- **最小通过**：方式一（Stub 链路）全部通过，即阶段 7 可验收通过。  
- **完整通过**：方式一 + 方式二 均通过（含真实 Webhook 签名校验与档位写入）。
